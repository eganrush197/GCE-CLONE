# Gaussian Splat Color System: Technical Documentation

**Date:** December 18, 2025  
**Status:** Diagnostic Investigation  
**Purpose:** Complete technical reference for color encoding, storage, and rendering

---

## Table of Contents

1. [Executive Summary](#executive-summary)
2. [Color Encoding System](#color-encoding-system)
3. [PLY File Format](#ply-file-format)
4. [Viewer Implementation](#viewer-implementation)
5. [Diagnostic Findings](#diagnostic-findings)
6. [Next Steps](#next-steps)

---

## 1. Executive Summary

This document provides a complete technical reference for how colors are encoded, stored, and rendered in the Gaussian Splat conversion pipeline. It serves as both documentation and a diagnostic guide for troubleshooting color-related issues.

### Key Components

1. **Color Encoding**: Spherical Harmonics (SH) DC coefficients
2. **Storage Format**: Binary PLY with 17 properties (68 bytes per vertex)
3. **Rendering**: WebGL shader with SH-to-RGB conversion
4. **Test Asset**: `packed-tree.blend` → `packed-tree_full.ply` (6.5M gaussians)

---

## 2. Color Encoding System

### 2.1 Spherical Harmonics (SH) DC Encoding

Colors are stored as **Spherical Harmonics Degree 0 (DC) coefficients**, not direct RGB values.

**Conversion Formula:**
```
RGB = SH_DC + 0.5
```

**Example:**
```
SH_DC = (-0.1048, -0.3298, -0.4922)
RGB   = (0.3952, 0.1702, 0.0078)  ← Brownish/orange color
```

### 2.2 Why SH Encoding?

1. **Compatibility**: Standard format for Gaussian Splatting research
2. **Extensibility**: Can add higher-order SH terms for view-dependent effects
3. **Range**: SH coefficients can be negative, allowing full RGB range [0, 1]

### 2.3 Value Ranges

| Property | SH DC Range | RGB Range | Notes |
|----------|-------------|-----------|-------|
| **Black** | -0.5 | 0.0 | Minimum value |
| **Grey** | 0.0 | 0.5 | Neutral/default |
| **White** | 0.5 | 1.0 | Maximum value |

---

## 3. PLY File Format

### 3.1 Header Structure

```
ply
format binary_little_endian 1.0
comment Generated by gaussian-mesh-converter
comment Phase 1 optimized format (68 bytes per vertex)
comment ===== DATA ENCODING NOTES =====
comment Scales: Stored in LOG SPACE - use exp(scale) to get linear values
comment Rotation: Quaternion format (w, x, y, z)
comment SH DC: Spherical harmonics degree 0 - RGB = SH_DC + 0.5
comment Normals: Currently unused, set to (0, 0, 0)
element vertex 6501966
property float x
property float y
property float z
property float nx
property float ny
property float nz
property float f_dc_0      ← Red channel (SH DC)
property float f_dc_1      ← Green channel (SH DC)
property float f_dc_2      ← Blue channel (SH DC)
property float opacity
property float scale_0     ← Log space!
property float scale_1     ← Log space!
property float scale_2     ← Log space!
property float rot_0       ← Quaternion W
property float rot_1       ← Quaternion X
property float rot_2       ← Quaternion Y
property float rot_3       ← Quaternion Z
end_header
[binary data follows...]
```

### 3.2 Binary Layout

**Total:** 17 properties × 4 bytes = 68 bytes per vertex

| Offset | Property | Type | Notes |
|--------|----------|------|-------|
| 0-11 | Position (x, y, z) | 3× float32 | World space coordinates |
| 12-23 | Normals (nx, ny, nz) | 3× float32 | Currently unused (0, 0, 0) |
| 24-35 | **SH DC (f_dc_0, f_dc_1, f_dc_2)** | 3× float32 | **Color data here!** |
| 36-39 | Opacity | 1× float32 | Alpha value [0, 1] |
| 40-51 | Scales (scale_0, scale_1, scale_2) | 3× float32 | **LOG SPACE** - use exp() |
| 52-67 | Rotation (rot_0, rot_1, rot_2, rot_3) | 4× float32 | Quaternion (w, x, y, z) |

### 3.3 Legacy Format (Deprecated)

The old format had 20 properties (71 bytes) with additional RGB bytes:
- Properties 18-20: `red`, `green`, `blue` (uchar)
- **This format is no longer used**

---

## 4. Viewer Implementation

### 4.1 Backend: PLY Parser

**File:** `viewer/backend/ply_parser.py`

**Key Code (lines 138-139):**
```python
# Convert SH DC to RGB colors (f_dc + 0.5, clamped to [0, 1])
colors = np.clip(sh_dc + 0.5, 0.0, 1.0)
```

**Binary Streaming (line 264):**
```python
# Keep SH DC as-is (don't convert to RGB)
# Conversion will happen in shader for proper rendering
sh_dc_list = list(sh_dc)
```

### 4.2 Frontend: WebGL Shader

**File:** `viewer/static/js/main.js`

**Vertex Shader (line 527):**
```glsl
// Convert SH DC to RGB color
vColor = instanceSHDC + 0.5;
```

**Fragment Shader (line 590):**
```glsl
// Output color with alpha
gl_FragColor = vec4(vColor, alpha);
```

### 4.3 Data Flow

```
PLY File (SH DC)
    ↓
Backend Parser (reads SH DC)
    ↓
Binary Stream (sends SH DC)
    ↓
Frontend (receives SH DC)
    ↓
Vertex Shader (converts: SH_DC + 0.5 → RGB)
    ↓
Fragment Shader (outputs RGB + alpha)
    ↓
Screen (rendered color)
```

---

## 5. Diagnostic Findings

### 5.1 Test Asset: packed-tree_full.ply

**File Stats:**
- Vertex count: 6,501,966
- File size: 442,134,484 bytes (421 MB)
- Format: Phase 1 optimized (68 bytes/vertex)

**Color Statistics (from PLY Inspector):**
```
SH DC → RGB:
  Min:  (0.119, 0.000, 0.000)
  Max:  (0.996, 0.996, 0.946)
  Mean: (0.451, 0.279, 0.082)  ← Brownish/orange (tree bark color!)

Direct RGB (0-255):
  Min:  (0, 0, 0)
  Max:  (0, 0, 0)
  Mean: (0.0, 0.0, 0.0)  ← Not used in Phase 1 format

Black vertices (RGB < 0.1): 0 (0.0%)
Opacity stats: min=0.100, max=1.000, mean=0.982
```

### 5.2 Sample Gaussian Data

**First Gaussian (V0):**
```
Position: (0.108, 0.060, 0.161)
SH DC:    (-0.1048, -0.3298, -0.4922)
RGB:      (0.395, 0.170, 0.008)  ← Brownish color ✓
Opacity:  1.000
```

### 5.3 Verification Checklist

✅ **Color Sampling**: Working - mean RGB (0.451, 0.279, 0.082) shows tree bark colors
✅ **PLY Storage**: Working - SH DC values correctly stored
✅ **PLY Parser**: Working - correctly reads f_dc_0, f_dc_1, f_dc_2
✅ **Shader Conversion**: Working - applies `SH_DC + 0.5` formula
✅ **Visual Output**: **COLORS VISIBLE!** Model renders with color in viewer
⚠️ **Channel Order Issue**: Colors are INVERTED - leaves are brown, bark is green

### 5.4 Channel Swap Issue **[FIXED]**

**Observed Behavior:**
- Tree leaves appear BROWN (should be green)
- Tree bark appears GREEN (should be brown)

**Root Cause Identified:**
Red and Green channels are swapped during Blender texture extraction. When Blender saves packed textures as PNG files, the channel order is GRB instead of RGB.

**Fix Applied:**
Added channel swap in `src/mesh_to_gaussian.py` line 415:
```python
# FIX: Swap Red and Green channels (Blender exports with swapped channels)
if len(img_array.shape) == 3 and img_array.shape[2] >= 3:
    img_array = img_array[:, :, [1, 0, 2]]  # Swap R and G channels (G, R, B)
```

This converts Blender's GRB format back to standard RGB format.

**Verification:**
Re-run conversion and check that:
- Leaves appear GREEN
- Bark appears BROWN
- Colors match the original Blender model

---

## 6. Applied Fix & Verification

### 6.1 Fix Applied (December 18, 2025)

The R/G channel swap was applied during texture loading in `mesh_to_gaussian.py` at lines 413-416:

```python
# FIX: Swap Red and Green channels (Blender exports with swapped channels)
# This fixes the issue where leaves appear brown and bark appears green
if len(img_array.shape) == 3 and img_array.shape[2] >= 3:
    img_array = img_array[:, :, [1, 0, 2]]  # Swap R and G channels (G, R, B)
```

This converts Blender's exported texture channel order to standard RGB for correct color display.

### 6.2 Verification Steps

After re-running conversion:

1. **Run the conversion:**
```bash
python -m src.pipeline.orchestrator packed-tree.blend --output output_test --packed
```

2. **Inspect the PLY file:**
```bash
python tools/ply_inspector.py output_test/packed-tree_full.ply 20
```

3. **Expected Results:**
   - Leaves should be GREEN (positive G channel, negative R channel in SH DC)
   - Bark should be BROWN (positive R channel, lower G channel in SH DC)
   - Colors should match the original Blender model

### 6.3 Diagnostic Tools

**PLY Inspector:**
```bash
python tools/ply_inspector.py output_clouds/packed-tree_full.ply 20
```

**Browser Console Logging:**
The viewer logs SH DC statistics when loading:
```javascript
logToConsole(`SH DC range: [${minSH.toFixed(3)}, ${maxSH.toFixed(3)}], avg: ${avgSH.toFixed(3)}`, 'debug');
```

Check these values match the PLY inspector output.

---

## Appendix A: Quick Reference

### Color Conversion
```python
# Python
rgb = np.clip(sh_dc + 0.5, 0.0, 1.0)
```

```glsl
// GLSL
vec3 rgb = sh_dc + 0.5;
```

### Diagnostic Commands
```bash
# Inspect PLY file
python tools/ply_inspector.py output_clouds/packed-tree_full.ply 20

# View PLY header
Get-Content output_clouds/packed-tree_full.ply -Head 30

# Start viewer
cd viewer
python server.py
```

---

**End of Documentation**

